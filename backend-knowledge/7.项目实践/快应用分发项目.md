首先，快应用是什么？快应用分发是什么？快应用分发是一个大的问题域，那么怎么样去处理呢？我们将大的问题拆成很多小的问题域；包括搜索，榜单，资源，动态客户端，评分等核心子域，活动，分类，账号，支付等通用子域。
## 1. 搜索子域
包括应用搜索以及应用内容搜索，分布式调度中心，分布式爬虫提高性能，应用内容导入 ElasticSearch，优化索引分词，召回，相关性排序，并使用 nDCG 评估搜索效果。
爬虫设方案难点：Redis，分布式爬虫；方案参考谷歌，苹果等应用内搜索方案。
关键问题：如何获取开发者数据，获取后的数据如何分发给用户。
关键点：
1）开发者适配快应用标准：setMeta(),setTitle()信息;开发者利用这两个API设置页面相关信息；
2）快应用浏览器渲染：快应用原本是运行在快应用引擎上的，要爬取数据，首先需要将快应用渲染为H5页面，渲染的时候会将setMeta()，setTitle的信息渲染到H5 Meta标签下；
3）分布式爬虫：爬虫有两个大问题：抓取数据完整性，爬取性能，一万个链接，单机去执行反正一下午都执行不完，然通过将下载链接放到Redis List（set去重）。
页面本身的复杂性以及前端环境：比如一个微博热搜页；怎么样去抓取数据的呢？
爬虫流程：Spider 实例初始化多个线程，每个线程会不断从RedisScheduler中获取Request，下载器会通过WebDriver下载渲染好的页面，收集器进行页面跳转链接收集，Processor提取数据,Pipiline将数据存入ES；
4）分布式调度中心：采用xxl-job作为分布式调度中心，调度爬虫执行；
5）内容索引：这部分不是我这边主要处理的，我就简单描述一下；提取的内容我们倒入ES，索引创建是用的是细粒度IK分词，搜索使用的是粗粒度IK分词，同时处理了拼音，同义词，停用词，通过functionScore调整相关性评分；
难点亮点：**Redis? 为什么不用消息队列？分布式爬虫？ES？线程池？**
1）方案设计：整套应用内搜索从标准到爬虫到内容搜索方案；
2）分布式爬虫设计与实现：Spider,下载器，页面处理器，链接收集器，RedisScheduler，分布式调度中心；
3）功能性问题：爬虫完整性；
4）性能问题：单机多线程，分布式爬虫；
IO密集型=2Ncpu（可以测试后自己控制大小，2Ncpu一般没问题）
计算密集型=Ncpu（常出现于线程中：复杂算法）
5）协调前端，产品，运营以及服务端同学，共同完成项目，对结果负责。
优化点：
功能性：通过爬虫获取的数据实时性比较差；那么如何接入实时性数据呢？需要提供统一的数据接入接口，通过推拉结合的方式获取开发者数据。
由于我们项目刚刚才做好MVP版本，很多问题没有处理，数据清洗？监控告警？调度成功率？爬虫成功？耗时？
## 2. 榜单子域
快应用资源按照一定的产品运行策略，根据资源各种维度的数据计算排行榜，将榜单分发给用户。
关键点：
1）榜单配置化管理：运营可以随意的配置榜单，关联榜单的数据源，度量值，过滤器及算法
2）定时任务获取分布式锁，获取成功后执行榜单计算任务；
3）榜单计算：数据源工厂根据数据源类型获取数据源加载器加载数据，前置过滤器责任链进行数据过滤（插入删除等），度量值处理器获取算法相关的度量值进行封装，算法工厂根据数据源及设定公式进行计算，计算后的数据通过后置过滤器（连续热榜干预），榜单最终存入 Redis 缓存。
4）连续热榜干预：通过连续热榜干预解决榜单“马太效应”问题
难点亮点：**设计模式？分布式锁？Redis缓存？RPC？**
1）模块设计：工厂，责任链等常用设计模式，配置化管理增加模块的扩展和复用性，新增一个榜单仅仅需要简单的配置。
2）分布式锁进行任务协同，分布式缓存提升服务性能，对外提供RPC服务；
优化点：
目前我们只有几千个资源，我们一次性全都放入一个列表里面；当资源数量增长，比如向100万个资源，还可以这样做吗？所有的请求都经过Redis，那么Redis是我们的热点，怎么优化呢？Redis分库，本地缓存+Redis二级缓存？
## 3. 资源子域
资源子域提供快应用分包的基础服务，包括快应用资源的上传入库，审核，同步，上架，更新，下载，资源屏蔽、灰度分发。等能力。
关键点：**集中在性能，Redis 缓存，RPC上。**
1）开发者在OPPO开放平台上传开发号的快应用资源，经过运营的审核测试，上架（上架会发送MQ消息：快应用ID，类型，事件类型）。
2）将所有上架状态的快应用加载到 Redis 缓存，提供资源更新检测，资源基础信息查询，资源下载，资源屏蔽，灰度分发等功能。
资源屏蔽：Redis Key 的设计空间换时间的思想，根据客户端传递的品牌，设配类型，地区等生成Key直接从Redis缓存获取数据，而不需要把数据拉取下来，转换成实体在堆每个条件进行if-else判断。
灰度发布对 imei 取哈希，让我们的用户均匀的分布到区间内，这其实也是吸收了一些数据分区的思想？
难点亮点：**高并发，性能？Redis缓存？MQ？RPC服务？**
1）简单高效，高并发，低延时，支持线上 30000 QPS 并发。分布式集群加缓存提升性能。
2）对外提供RPC服务（负载均衡：最少活跃数，异步调用），通过MQ发送资源上下架等领域事件。
优化点：
当数据规模变成100万个应用？我还能否用这样的方式去处理？缓存问题？缓存与数据库的一致性。
Redis是我们的热点：可否优化？分库？
## 4.整体架构
**DDD？负载均衡？限流熔断？分布式集群？异地多活？**
1.模块拆分：这里面我们参考了一些领域驱动设计的理念，进行快应用分发 DDD 领域建模。
2.分布式通信：搜索子域需要调用资源子域获取资源信息以及进行资源屏蔽；榜单子域需要访问评分子域的评分结果，访问资源子域的资源信息及资源屏蔽。内部三方需要感知快应用的上下架等？模块之间通过RPC，或MQ通信。
3.高性能：各服务独立集群部署，灵活使用分布式缓存Redis，提升系统性能。
4.高可用：网关层负载均衡，限流熔断。服务层的集群及负载均衡。网关层、配置中心、应用层、中间件及MySQL采用北京昌平到广州连云异地双活设计，提升系统可用性。
优化点：
可用性优化：监控告警，关键链路限流熔断降级；