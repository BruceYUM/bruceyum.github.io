# 微服务 vs DDD vs 中台


[toc]

# 微服务

## 微服务概述

### 1、软件架构模式演进

**1. 第一阶段是单机架构**

采用面向过程的设计方法，系统包括客户端 UI 层和数据库两层，采用 C/S 架构模式，整个系统围绕数据库驱动设计和开发，并且总是从设计数据库和字段开始。

单体：JEE+Web 容器，SSH 框架

单体架构的劣势

- 耦合，互相依赖

- 所有功能混合在一个JVM进程里面，工程大，打包，上线等等都有问题。

**2. 第二阶段是集中式架构**

采用面向对象的设计方法，系统包括业务接入层、业务逻辑层和数据库层，采用经典的三层架构，也有部分应用采用传统的 SOA 架构。这种架构容易使系统变得臃肿，可扩展性和弹性伸缩性差。

**3. 第三阶段是分布式微服务架构**

SOA：Web Service、ESB

随着微服务架构理念的提出，集中式架构正向分布式微服务架构演进。微服务架构可以很好地实现应用之间的解耦，解决单体应用扩展性和弹性伸缩能力不足的问题。

在系统建设过程中，我们经常会看到这样的情形：A 负责提出需求，B 负责需求分析，C 负责系统设计，D 负责代码实现，这样的流程很长，经手的人也很多，很容易导致信息丢失。最后，就很容易导致需求、设计与代码实现的不一致，往往到了软件上线后，我们才发现很多功能并不是自己想要的，或者做出来的功能跟自己提出的需求偏差太大。

### 2、微服务的准则

1. 单一职责

2. 每个服务运行在独立的进程中

3. 集群，每个实例运行在容器化的平台内，达到平滑伸缩的效果，根据性能需求，水平伸缩

4. 服务可以独享自己的数据储存，比如数据库，缓存，消息队列去数据共享模式，就是不要使用同一个数据库，不要使用同一个缓存数据key，同一个消息队列topic

5. 每个服务有独立的产品，开发，运维，运营人员。职能划分明确，高度自治，便于管理。

根据康威定律，团队的交流机制应该与架构设计机制相对应。

康威定律是马尔文·康威1967提出的：“设计系统的架构受制于产生这些设计的组织的沟通结构。”通俗的来讲：产品必然是其（人员）组织沟通结构的缩影。跨部门沟通是非常难的，系统各个模块的接口也反映了它们之间的信息流动和合作方式。康威定律可谓软件架构设计中的第一定律，起初只是在杂志上的发表，后经过《人月神话》这本软件界圣经的引用，并命名为康威定律（Conway’s law），因此得以推广。

只通过简单的描述可能无法理解康威定律的精髓所在，原文中康威定律可总结为四个定律：

- 第一定律 组织沟通方式会通过系统设计表达出来。

- 第二定律 时间再多一件事情也不可能做的完美，但总有时间做完一件事情。

- 第三定律 线型系统和线型组织架构间有潜在的异质同态特性。
直白的说就是想要什么的系统就搭建什么样的团队，有什么样的团队就搭建什么样的系统。需要前后端分离的系统就搭建前后端分离的团队，反之，拥有前后端分离的团队，可以设计前后端分离的系统。当然，如果能统筹管理，拥有重组团队或设计系统架构的权利，那就再好不过了。通常情况下让两者形成1：1的映射关系，更加高效。

![img](http://cdn.processon.com/5f86e2b407912906db269fba?e=1602678980&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:Y6G_YQg3JykhLwJiAI8KRc1cJGY=)

![img](http://cdn.processon.com/5f86e2dbf346fb06e1d38f37?e=1602679019&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:TSLBXDBZfCeT43ivFLQwYqlCL7M=)

- 第四定律 大的系统组织总是比小系统更倾向于分解。

- 在微服务架构中，提出运维也是服务项目团队的一员，倡导谁开发，谁维护，实行终身维护制度。

6. 去中心化治理
API网关是一个反微服务化的例子

### 3、微服务拆分的困境

我认为微服务拆分困境产生的根本原因就是不知道业务或者微服务的边界到底在什么地方。

**DDD 核心思想是通过****领域驱动设计****方法定义领域模型，从而确定业务和应用边界，保证业务模型与代码模型的一致性。**


### 4、微服务的设计模式

**1、服务组合模式**

**1. 服务代理模式**

微服务系统平滑迁移经常需要使用这种模式，微服务系统平滑迁移步骤：

- 新老系统双写
比如有用户来注册，那么这个用户就是新用户就写到新系统。
有老用户来修改个人信息，那么这个用户就是老用户写老系统。（方案2: 老用户修改个人信息，先查insert/insert失败然后更新，insert成功也更新新的系统。）

- 迁移双写前的遗留数据
这里代码需要做出容错，在迁移的过程中比如读老用户信息没有，需要在新系统再查一次，因为是逐步迁移的。

- 将读请求切换到新系统
用到代理模式的开关，其实nginx也是微服务中的服务代理模式

- 下单双写的逻辑，只写新系统
当到达迁移最后一条记录的时候下线老系统，也就是说这里要准备好2个代码版本。一个是新老系统双写，一个是单写新系统。

服务代理模式，常常在第三步，做一个读请求切换开关。将读的请求切换到了的系统。

**2. 服务聚合模式**

**3. 服务串联模式**

- 不推荐
- 这种模式层次一多，容易互相依赖
- 底层加一层，对上面一层也是无感知的

**4. 服务分支模式**

- 服务分支模式就是 代理模式，聚合模式，串联模式三者结合起来使用。
- 不建议使用，增加架构的复杂度。保持服务依赖关系清晰明了，减少运维工作。

**5. 服务异步消息模式**

**6. 服务共享数据模式**

其实这个是反微服务设计模式，在下面两种情况需要设计共享模式

- 单元化架构穷，没那么多机器
- 遗留的整体服务

**2、 服务容错模式**

- 服务隔离模式


### 5、微服务的设计原则

1. AKF 拆分原则

AKF 可扩展立方（Scalability Cube）
《可扩展的艺术》一书提出了一 个更加系统的可扩展模型—— AKF 可扩展立方
![img](http://cdn.processon.com/5fa2193763768943485a2024?e=1604462407&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:f0K7IbOQN7bmR7xnBAgSaf7oWFs=)

- X 轴(水平扩展) —— 关注水平扩展，也就是”加机器解决问题”，集群
- Y 轴(功能) —— 关注应用中功能划分，基于不同的业务拆分
- Z 轴(数据分区) —— 关注服务和数据的优先级划分，如按地域划分
    - 单元化架构
    - 数据分区

2. 前后端分离原则

3. 无状态服务


### 6、可扩展性

1、技术可扩张性

2、业务可扩展性

服务聚合模式的应用层，提高了业务的可扩展性

在支付宝一代的业务架构中，前台的业务和后台的业务直接耦合，形成了多对多的网状结构，如果修改一个后台业务线，就会影响到很多前台业务线；如果增加一条新的前台业务线，需要同时和很多后台业务线对接，这样的架构无疑是对业务的扩展非常不利的。
而在支付宝二代业务架构中，你会发现，他们在前后台业务线之间，构建了独立的支付清算平台，从而实现了前台业务和后台业务的解耦。在这里，不管前台业务，还是后台业务，都只需要对接中间的支付清算平台，把系统的变化收敛到一个点，而业务线之间相互不影响，这样的方式，自然可以很好地支持业务扩展。

![img](http://cdn.processon.com/5fa21e361e08534d5564d836?e=1604463686&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:Qd8psLek2p1FhlgjK6Pnf6U6FFM=)

**服务聚合模式的中心模式，提高了业务的可复用性**

### 7、可复用性

![img](http://cdn.processon.com/5fa21f8263768943485a4407?e=1604464019&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:J6Su5QUCj3zHUSzonhaSDXP2oF0=)


# DDD领域驱动设计

## DDD概述

### 1、DDD定义
**DDD 是一种处理高度复杂领域的设计思想**，它试图分离技术实现的复杂性，并围绕业务概念构建领域模型来控制业务的复杂性，以解决软件难以理解，难以演进的问题。**DDD 不是架构，而是一种架构设计方法论**，它通过边界划分将复杂业务领域简单化，帮我们设计出清晰的领域和应用边界，可以很容易地实现架构演进。

### 2、 战略设计

战略设计主要从业务视角出发，建立业务领域模型，划分领域边界，建立通用语言的限界上下文，限界上下文可以作为微服务设计的参考边界。

**DDD 战略设计会建立领域模型**，领域模型可以用于指导微服务的设计和拆分。

**事件风暴**是建立领域模型的主要方法，它是一个从发散到收敛的过程。

事件风暴过程会产生很多的实体、命令、事件等领域对象，我们将这些领域对象从不同的维度进行聚类，形成如聚合、限界上下文等边界，建立领域模型，这就是一个收敛的过程。

发散：通常采用**用例分析、场景分析和用户旅程分析**，尽可能全面不遗漏地分解业务领域，并梳理领域对象之间的关系，这是一个发散的过程。

收敛：事件风暴过程会**产生很多的实体、命令、事件等领域对象**，我们将这些领域对象从不同的维度进行聚类，形成如聚合、限界上下文等边界，建立领域模型，这就是一个收敛的过程。

事件风暴需要准备些什么？

- 事件风暴的参与者

- 事件风暴要准备的材料
事件风暴参与者会将自己的想法和意见写在即时贴上，并将贴纸贴在墙上的合适位置，我们戏称这个过程是“刷墙”。所以即时贴和水笔是必备材料，另外，你还可以准备一些胶带或者磁扣，以便贴纸随时能更换位置。

- 事件风暴的场地

- 事件风暴分析的关注点
    - 产品愿景
    - 业务场景分析
    - 领域建模

输入：用户操作、事件以及外部依赖关系

输出：通用语言，限界上下文，领域模型（包括领域中的领域对象）

案例

![img](http://cdn.processon.com/5f891520e401fd06fd8d842d?e=1602822960&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:EzNSoNCyttW7SbnvVRMdDckfWCE=)


1. 采用事件风暴，根据业务行为，梳理出在投保过程中发生这些行为的所有的实体和值对象，比如投保单、标的、客户、被保人等等。 
2. 从众多实体中选出适合作为对象管理者的根实体，也就是聚合根。判断一个实体是否是聚合根，你可以结合以下场景分析：是否有独立的生命周期？是否有全局唯一 ID？是否可以创建或修改其它对象？是否有专门的模块来管这个实体。图中的聚合根分别是投保单和客户实体。 
3. 根据业务单一职责和高内聚原则，找出与聚合根关联的所有紧密依赖的实体和值对象。构建出 1 个包含聚合根（唯一）、多个实体和值对象的对象集合，这个集合就是聚合。在图中我们构建了客户和投保这两个聚合。 
4. 在聚合内根据聚合根、实体和值对象的依赖关系，画出对象的引用和依赖模型。这里我需要说明一下：投保人和被保人的数据，是通过关联客户 ID 从客户聚合中获取的，在投保聚合里它们是投保单的值对象，这些值对象的数据是客户的冗余数据，即使未来客户聚合的数据发生了变更，也不会影响投保单的值对象数据。从图中我们还可以看出实体之间的引用关系，比如在投保聚合里投保单聚合根引用了报价单实体，报价单实体则引用了报价规则子实体。 
5. 多个聚合根据业务语义和上下文一起划分到同一个限界上下文内。 


### 3、战术设计

战术设计则从技术视角出发，侧重于领域模型的技术实现，完成软件开发和落地，包括：聚合根、实体、值对象、领域服务、应用服务和资源库等代码逻辑的设计和实现。

- 将领域模型中的领域对象与代码模型中的代码对象建立映射关系，将业务架构和系统架构进行绑定。当我们去响应业务变化调整业务架构和领域模型时，系统架构也会同时发生调整，并同步建立新的映射关系。

- 输入：领域模型

- 输出：代码

- 落地

## DDD名词解析

### 1、领域

DDD 的领域就是特定的边界内要解决的业务问题域。领域可以拆分为多个子领域。

**一个领域相当于一个问题域，领域拆分为子域的过程就是大问题拆分为小问题的过程。**

### 2、子领域

如何划分子域
核心思想就是将问题域逐步分解，降低业务理解和系统实现的复杂度。

``` 保险是个比较大的领域，很早以前的保险核心系统把所有的功能都放在一个系统里来实现，这个系统就是我们常说的单体系统。后来单体系统开始无法适应保险业务的发展，因此保险公司开始了中台转型，引入分布式微服务架构来替换原来的单体系统。而分布式微服务架构就需要划分业务领域边界，建立领域模型，并实现微服务落地了。 为实现保险领域建模和微服务建设，我们可以根据业务关联度以及流程边界将保险领域细分为：承保、收付、再保以及理赔等子域，而承保子域还可以继续细分为投保、保全（寿险）、批改（财险）等子子域。 在投保这个限界上下文内可以建立投保的领域模型，投保的领域模型最后映射到系统就是投保微服务。这就是一个保险领域的细分和微服务的建设过程。 那么你可能会说，我不是保险行业的人，我怎么理解这个过程呢？我认为，不同行业的业务模型可能会不一样，但领域建模和微服务建设的过程和方法基本类似，其核心思想就是将问题域逐步分解，降低业务理解和系统实现的复杂度。 ```

子域可以根据自身重要性和功能属性划分为三类子域

- 核心域：决定产品和公司核心竞争力的子域是核心域，它是业务成功的主要因素和公司的核心竞争力。

- 通用域:没有太多个性化的诉求，同时被多个子域使用的通用功能子域是通用域。

通用域则是你需要用到的通用系统，比如认证、权限等等，这类应用很容易买到，没有企业特点限制，不需要做太多的定制化。

- 支撑域

既不包含决定产品和公司核心竞争力的功能，也不包含通用功能的子域，它就是支撑域。

支撑域则具有企业特性，但不具有通用性，例如数据代码类的数据字典等系统。

包含：实体、值对象、聚合、聚合根

总结：领域的核心思想就是将问题域逐级细分，来降低业务理解和系统实现的复杂度。通过领域细分，逐步缩小微服务需要解决的问题域，构建合适的领域模型，而领域模型映射成系统就是微服务了。 核心域、支撑域和通用域的主要目标是：通过领域划分，区分不同子域在公司内的不同功能属性和重要性，从而公司可对不同子域采取不同的资源投入和建设策略，其关注度也会不一样。

### 3、通用语言

**在事件风暴过程中，通过团队交流达成共识的，能够简单、清晰、准确描述业务涵义和规则的语言就是通用语言。**

通用语言包含术语和用例场景，并且能够直接反映在代码中。

1. 在事件风暴的过程中，领域专家会和设计、开发人员一起建立领域模型，在领域建模的过程中会形成通用的业务术语和用户故事。事件风暴也是一个项目团队统一语言的过程。 

2. 通过用户故事分析会形成一个个的领域对象，这些领域对象对应领域模型的业务对象，每一个业务对象和领域对象都有通用的名词术语，并且一一映射。 

3. 微服务代码模型来源于领域模型，每个代码模型的代码对象跟领域对象一一对应。

通用语言中的名词：给领域对象命名，如商品、订单等，对应实体对象

通用语言中的动词：表示一个动作或事件，如商品已下单、订单已付款等，对应领域事件或者命令。

通用语言落地

设计过程中我们可以用一些表格，来记录事件风暴和微服务设计过程中产生的领域对象及其属性。

![img](http://cdn.processon.com/5f8810ddf346fb06e1d5da17?e=1602756334&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:D_TtYhIDfOYiaRILTz72UI07r74=)

### 4、限界上下文

**限界上下文的定义：用来封装通用语言和领域对象，提供上下文环境，保证在领域之内的一些术语、业务相关对象等（通用语言）有一个确切的含义，没有二义性。**

**领域边界就是通过限界上下文来定义的。**

**理论上限界上下文就是微服务的边界。我们将限界上下文内的领域模型映射到微服务，就完成了从问题域到软件的解决方案。**

为什么要有限界上下文？

语言都有它的语义环境，同样，通用语言也有它的上下文环境。为了避免同样的概念或语义在不同的上下文环境中产生歧义，DDD 在战略设计上提出了“限界上下文”这个概念，用来确定语义所在的领域边界。

### 5、 实体

一种对象，它拥有唯一标识符，且标识符在历经各种状态变更后仍能保持一致。对它而言，重要的不是其属性，而是其延续性和标识，对象的延续性和标识会跨越甚至超出软件的生命周期。

实体是看得到、摸得着的实实在在的业务对象，实体具有业务属性、业务行为和业务逻辑。实体的四种形态：

**1. 实体的业务形态**

在 DDD 不同的设计过程中，实体的形态是不同的。在战略设计时，实体是领域模型的一个重要对象。领域模型中的实体是多个属性、操作或行为的载体。在事件风暴中，我们可以根据命令、操作或者事件，找出产生这些行为的业务实体对象，进而按照一定的业务规则将依存度高和业务关联紧密的多个实体对象和值对象进行聚类，形成聚合。你可以这么理解，实体和值对象是组成领域模型的基础单元。

**2. 实体的代码形态**

在代码模型中，实体的表现形式是实体类，这个类包含了实体的属性和方法，通过这些方法实现实体自身的业务逻辑。在 DDD 里，这些实体类通常采用充血模型，与这个实体相关的所有业务逻辑都在实体类的方法中实现，跨多个实体的领域逻辑则在领域服务中实现。

**这些实体类可以采用充血模型/贫血模型**

- 充血模型：充血模型层次结构和上面的差不多，不过大多业务逻辑和持久化放在领域对象里面，领域层只是简单封装部分业务逻辑以及控制事务

- 贫血模型：贫血模型是指领域对象里只有get和set方法（POJO），所有的业务逻辑都不包含在内而是放在领域层。

该模型的缺点是不够面向对象，领域对象只是作为保存状态或者传递状态使用，它是没有生命的，只有数据没有行为的对象不是真正的对象

贫血模型实施的最大难度在于如何梳理好 Business Logic 层内部的划分关系

**3. 实体的运行形态**

实体以 DO（领域对象）的形式存在，每个实体对象都有唯一的 ID。我们可以对一个实体对象进行多次修改，修改后的数据和原来的数据可能会大不相同。但是，由于它们拥有相同的 ID，它们依然是同一个实体。比如商品是商品上下文的一个实体，通过唯一的商品 ID 来标识，不管这个商品的数据如何变化，商品的 ID 一直保持不变，它始终是同一个商品。

**4. 实体的数据库形态**

与传统数据模型设计优先不同，DDD 是先构建领域模型，针对实际业务场景构建实体对象和行为，再将实体对象映射到数据持久化对象。

业务实体，代码实体，数据库实体对应关系

在领域模型映射到数据模型时，一个实体可能对应 0 个、1 个或者多个数据库持久化对象。大多数情况下实体与持久化对象是一对一。在某些场景中，有些实体只是暂驻静态内存的一个运行态实体，它不需要持久化。比如，基于多个价格配置数据计算后生成的折扣实体。 而在有些复杂场景下，实体与持久化对象则可能是一对多或者多对一的关系。比如，用户 user 与角色 role 两个持久化对象可生成权限实体，一个实体对应两个持久化对象，这是一对多的场景。再比如，有些场景为了避免数据库的联表查询，提升系统性能，会将客户信息 customer 和账户信息 account 两类数据保存到同一张数据库表中，客户和账户两个实体可根据需要从一个持久化对象中生成，这就是多对一的场景。

**5. 实体特点**

有 ID 标识，通过 ID 判断相等性，ID 在聚合内唯一即可。状态可变，它依附于聚合根，其生命周期由聚合根管理。实体一般会持久化，但与数据库持久化对象不一定是一对一的关系。实体可以引用聚合内的聚合根、实体和值对象。


### 6、值对象

通过对象属性值来识别的对象，它将多个相关属性组合为一个概念整体。

简单来说，值对象本质上就是一个属性集。比如人员实体原本包括：姓名、年龄、性别以及人员所在的省、市、县和街道等属性。这样显示地址相关的属性就很零碎了对不对？现在，我们可以将“省、市、县和街道等属性”拿出来构成一个“地址属性集合”，这个集合就是值对象了。

值对象只是若干个属性的集合，只有数据初始化操作和有限的不涉及修改数据的行为，基本不包含业务逻辑。值对象的四种形态：

1. 值对象的业务形态

2. 值对象的代码形态

3. 值对象的运行形态

值对象嵌入到实体两种方式

- 属性嵌入的方式

![img](http://cdn.processon.com/5f88ff90e401fd06fd8d1f9d?e=1602817441&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:0JxHmVNn0LoOo4PUQ00TuZ9nmK0=)

- 序列化大对象

![img](http://cdn.processon.com/5f88ffa363768906e673e433?e=1602817459&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:xT_ft6oVRPLR7bCgt33lGGaO_0U=)


4. 值对象的数据库形态

在领域建模时，我们可以将部分对象设计为值对象，保留对象的业务涵义，同时又减少了实体的数量；
在数据建模时，我们可以将值对象嵌入实体，减少实体表的数量，简化数据库设计。

值对象采用序列化大对象的方法简化了数据库设计，减少了实体表的数量，可以简单、清晰地表达业务概念。

这种设计方式虽然降低了数据库设计的复杂度，但却无法满足基于值对象的快速查询，会导致搜索值对象属性值变得异常困难。

值对象采用属性嵌入的方法提升了数据库的性能

但如果实体引用的值对象过多，则会导致实体堆积一堆缺乏概念完整性的属性，这样值对象就会失去业务涵义，操作起来也不方便。

值对象的特点

无 ID，不可变，无生命周期，用完即扔。值对象之间通过属性值判断相等性。它的核心本质是值，是一组概念完整的属性组成的集合，用于描述实体的状态和特征。值对象尽量只引用值对象。

### 7、 聚合

聚合在 DDD 分层架构里属于领域层，领域层包含了多个聚合，共同实现核心业务逻辑。聚合内实体以充血模型实现个体业务能力，以及业务逻辑的高内聚。跨多个实体的业务逻辑通过领域服务来实现，跨多个聚合的业务逻辑通过应用服务来实现。比如有的业务场景需要同一个聚合的 A 和 B 两个实体来共同完成，我们就可以将这段业务逻辑用领域服务来实现；而有的业务逻辑需要聚合 C 和聚合 D 中的两个服务共同完成，这时你就可以用应用服务来组合这两个服务。

领域模型内的实体和值对象就好比个体，而能让实体和值对象协同工作的组织就是聚合，它用来确保这些领域对象在实现共同的业务逻辑时，能保证数据的一致性。


聚合有两部分

- 聚合根

-- 上下文边界：这个边界根据业务单一职责和高内聚原则，定义了聚合内部应该包含哪些实体和值对象，而聚合之间的边界是松耦合的。

聚合设计的5项原则

**1. 在一致性边界内建模真正的不变条件。**

聚合用来封装真正的不变性，而不是简单地将对象组合在一起。聚合内有一套不变的业务规则，各实体和值对象按照统一的业务规则运行，实现对象数据的一致性，边界之外的任何东西都与该聚合无关，这就是聚合能实现业务高内聚的原因。

**2. 设计小聚合。**

如果聚合设计得过大，聚合会因为包含过多的实体，导致实体之间的管理过于复杂，高频操作时会出现并发冲突或者数据库锁，最终导致系统可用性变差。而小聚合设计则可以降低由于业务过大导致聚合重构的可能性，让领域模型更能适应业务的变化。

**3. 通过唯一标识引用其它聚合。**

聚合之间是通过关联外部聚合根 ID 的方式引用，而不是直接对象引用的方式。外部聚合的对象放在聚合边界内管理，容易导致聚合的边界不清晰，也会增加聚合之间的耦合度。

**4. 在边界之外使用最终一致性。**

聚合内数据强一致性，而聚合之间数据最终一致性。在一次事务中，最多只能更改一个聚合的状态。如果一次业务操作涉及多个聚合状态的更改，应采用领域事件的方式异步修改相关的聚合，实现聚合之间的解耦（相关内容我会在领域事件部分详解）。

**5. 通过应用层实现跨聚合的服务调用。**

为实现微服务内聚合之间的解耦，以及未来以聚合为单位的微服务组合和拆分，应避免跨聚合的领域服务调用和跨聚合的数据库表关联。

聚合的特点

高内聚、低耦合，它是领域模型中最底层的边界，可以作为拆分微服务的最小单位，但我不建议你对微服务过度拆分。但在对性能有极致要求的场景中，聚合可以独立作为一个微服务，以满足版本的高频发布和极致的弹性伸缩能力。

### 8、 聚合根

聚合根的主要目的是为了避免由于复杂数据模型缺少统一的业务规则控制，而导致聚合、实体之间数据不一致性的问题。

聚合根特点

聚合根是实体，有实体的特点，具有全局唯一标识，有独立的生命周期。一个聚合只有一个聚合根，聚合根在聚合内对实体和值对象采用直接对象引用的方式进行组织和协调，聚合根与聚合根之间通过 ID 关联的方式实现聚合之间的协同。

比如会员卡的卡号

如果把聚合比作组织，那聚合根就是这个组织的负责人。聚合根也称为根实体，它不仅是实体，还是聚合的管理者。

``` 首先它作为实体本身，拥有实体的属性和业务行为，实现自身的业务逻辑。 其次它作为聚合的管理者，在聚合内部负责协调实体和值对象按照固定的业务规则协同完成共同的业务逻辑。 最后在聚合之间，它还是聚合对外的接口人，以聚合根 ID 关联的方式接受外部任务和请求，在上下文内实现聚合之间的业务协同。也就是说，聚合之间通过聚合根 ID 关联引用，如果需要访问其它聚合的实体，就要先访问聚合根，再导航到聚合内部实体，外部对象不能直接访问聚合内实体。 ```

### 9、 领域事件

领域事件表示领域中发生的事件，一个领域事件将导致进一步的业务操作。

**1. 如何识别领域事件**

在做用户旅程或者场景分析时，我们要捕捉业务、需
求人员或领域专家口中的关键词：“如果发生……，则……”“当做完……的时候，请通
知……”“发生……时，则……”等。在这些场景中，如果发生某种事件后，会触发进一步的
操作，那么这个事件很可能就是领域事件。

比如微服务的消息队列

在边界之外使用最终一致 性。一次事务最多只能更改一个聚合的状态。如果一次业务操作涉及多个聚合状态的更改， 应采用领域事件的最终一致性。 领域事件驱动设计可以切断领域模型之间的强依赖关系，事件发布完成后，发布方不必关心 后续订阅方事件处理是否成功，这样可以实现领域模型的解耦，维护领域模型的独立性和数 据的一致性。在领域模型映射到微服务系统架构时，领域事件可以解耦微服务，微服务之间 的数据不必要求强一致性，而是基于事件的最终一致性。


1. 微服务内的领域事件

``` 当领域事件发生在微服务内的聚合之间，领域事件发生后完成事件实体构建和事件数据持久 化，发布方聚合将事件发布到事件总线，订阅方接收事件数据完成后续业务操作。 微服务内大部分事件的集成，都发生在同一个进程内，进程自身可以很好地控制事务，因此 不一定需要引入消息中间件。但一个事件如果同时更新多个聚合，按照 DDD“一次事务只 更新一个聚合”的原则，你就要考虑是否引入事件总线。但微服务内的事件总线，可能会增 加开发的复杂度，因此你需要结合应用复杂度和收益进行综合考虑。 微服务内应用服务，可以通过跨聚合的服务编排和组合，以服务调用的方式完成跨聚合的访 问，这种方式通常应用于实时性和数据一致性要求高的场景。这个过程会用到分布式事务， 以保证发布方和订阅方的数据同时更新成功。 ```

2. 微服务之间的领域事件

``` 跨微服务的领域事件会在不同的限界上下文或领域模型之间实现业务协作，其主要目的是实 现微服务解耦，减轻微服务之间实时服务访问的压力。 领域事件发生在微服务之间的场景比较多，事件处理的机制也更加复杂。跨微服务的事件可 以推动业务流程或者数据在不同的子域或微服务间直接流转。 跨微服务的事件机制要总体考虑事件构建、发布和订阅、事件数据持久化、消息中间件，甚 至事件数据持久化时还可能需要考虑引入分布式事务机制等。 微服务之间的访问也可以采用应用服务直接调用的方式，实现数据和服务的实时访问，弊端 就是跨微服务的数据同时变更需要引入分布式事务，以确保数据的一致性。分布式事务机制 会影响系统性能，增加微服务之间的耦合，所以我们还是要尽量避免使用分布式事务。 ```

通过领域事件驱动的异步化机制，可以推动业务流程和数据在各个不同微服务之间的
流转，实现微服务的解耦，减轻微服务之间服务调用的压力，提升用户体验。

**2. 领域事件总体架构**

![img](http://cdn.processon.com/5f8938ecf346fb06e1d7d02e?e=1602832124&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:sz9mCEdwOaJhNWSlUBHnzsf3rTc=)

1. 事件构建和发布

2. 事件数据持久化

3. 事件总线 (EventBus)：发送消息到MQ，如果发送失败就保存到事件表

4. 消息中间件

5. 事件接收和处理


## DDD进阶

如何通过领域事件实现微服务解耦？

怎样进行微服务分层设计？

如何实现层与层之间的服务协作？

通过几种微服务架构模型的对比分析，让你了解领域模型和微服务分层的作用和价值。

### 1、DDD 分层架构

![img](http://cdn.processon.com/5f893bde7d9c0806f27a6bc0?e=1602832879&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:_in8iouaTKQkDb3YfWHebelNRLI=)

用户接口层负责向用户显示信息和解释用户指令。这里的用户可能是：用户、程序、自动化
测试和批处理脚本等等。

应用层是很薄的一层，理论上不应该有业务规则或逻辑，主要面向用例和流程相关的操作。
但应用层又位于领域层之上，因为领域层包含多个聚合，所以它可以协调多个聚合的服务和
领域对象完成服务编排和组合，协作完成业务操作。

``` 此外，应用层也是微服务之间交互的通道，它可以调用其它微服务的应用服务，完成微服务之间的服务组合和编排。 这里我要提醒你一下：在设计和开发时，不要将本该放在领域层的业务逻辑放到应用层中实 现。因为庞大的应用层会使领域模型失焦，时间一长你的微服务就会演化为传统的三层架构，业务逻辑会变得混乱。 另外，应用服务是在应用层的，它负责服务的组合、编排和转发，负责处理业务用例的执行顺序以及结果的拼装，以粗粒度的服务通过 API 网关向前端发布。还有，应用服务还可以进行安全认证、权限校验、事务控制、发送或订阅领域事件等。 ```

领域层的作用是实现企业核心业务逻辑，通过各种校验手段保证业务的正确性。领域层主要

体现领域模型的业务能力，它用来表达业务概念、业务状态和业务规则。

``` 领域层包含聚合根、实体、值对象、领域服务等领域模型中的领域对象。这里我要特别解释一下其中几个领域对象的关系，以便你在设计领域层的时候能更加清楚。 首先，领域模型的业务逻辑主要是由实体和领域服务来实现的，其中实体会采用充血模型来实现所有与之相关的业务功能。其次，你要知道，实体和领域对象在实现业务逻辑上不是同级的，当领域中的某些功能，单一实体（或者值对象）不能实现时，领域服务就会出马，它可以组合聚合内的多个实体（或者值对象），实现复杂的业务逻辑。 ```

基础层

``` 基础层是贯穿所有层的，它的作用就是为其它各层提供通用的技术和基础服务，包括第三方工具、驱动、消息中间件、网关、文件、缓存以及数据库等。比较常见的功能还是提供数据库持久化。 基础层包含基础服务，它采用依赖倒置设计，封装基础资源服务，实现应用层、领域层与基础层的解耦，降低外部资源变化对应用的影响。 比如说，在传统架构设计中，由于上层应用对数据库的强耦合，很多公司在架构演进中最担忧的可能就是换数据库了，因为一旦更换数据库，就可能需要重写大部分的代码，这对应用来说是致命的。那采用依赖倒置的设计以后，应用层就可以通过解耦来保持独立的核心业务逻辑。当数据库变更时，我们只需要更换数据库基础服务就可以了，这样就将资源变更对应用的影响降到了最低。 ```

DDD 分层架构最重要的原则

**DDD 分层架构有一个重要的原则：每层只能与位于其下方的层发生耦合。**


架构根据耦合的紧密程度又可以分为两种

- 严格分层架构：严格分层架构中，领域服务只能被应用服务调用，而应用服务只能被用户接口层调用，服务是逐层对外封装或组合的，依赖关系清晰。

- 松散分层架构：在松散分层架构中，领域服务可以同时被应用层或用户接口层调用，服务的依赖关系比较复杂且难管理，甚至容易使核心业务逻辑外泄。


### 2、DDD 分层架构如何推动架构演进


**1、微服务架构的演进**

![img](http://cdn.processon.com/5f893f55e0b34d071109d301?e=1602833766&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:LjTnJKkkcmPMcJymoBX1TfS56Nk=)

我们结合上图，以微服务 1 为例，讲解下微服务架构的演进过程：

- 当你发现微服务 1 中聚合 a 的功能经常被高频访问，以致拖累整个微服务 1 的性能时，我们可以把聚合 a 的代码，从微服务 1 中剥离出来，独立为微服务 2。这样微服务 2 就可轻松应对高性能场景。 

- 在业务发展到一定程度以后，你会发现微服务 2 的领域模型有了变化，聚合 d 会更适合放到微服务 1 的领域模型中。这时你就可以将聚合 d 的代码整体搬迁到微服务 1 中。如果你在设计时已经定义好了聚合之间的代码边界，这个过程不会太复杂，也不会花太多时间。

- 最后我们发现，在经历模型和架构演进后，微服务 1 已经从最初包含聚合 a、b、c，演进为包含聚合 b、c、d 的新领域模型和微服务了。

**2、微服务内服务的演进**

![img](http://cdn.processon.com/5f894050f346fb06e1d7f036?e=1602834017&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:RGGksamUPbLwRHqofFkWp4jkrEU=)

我们看下上面这张图。在服务设计时，你并不一定能完整预测有哪些下层服务会被多少个上层服务组装，因此领域层通常只提供一些原子服务，比如领域服务 a、b、c。但随着系统功能增强和外部接入越来越多，应用服务会不断丰富。有一天你会发现领域服务 b 和 c 同时多次被多个应用服务调用了，执行顺序也基本一致。这时你可以考虑将 b 和 c 合并，再将应用服务中 b、c 的功能下沉到领域层，演进为新的领域服务（b+c）。这样既减少了服务的数量，也减轻了上层服务组合和编排的复杂度。


### 3、DDD四层架构 vs 传统三层架构

![img](http://cdn.processon.com/5f8940e17d9c0806f27a8216?e=1602834162&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:6cFvPqyGLleBumurMBRvBZFW1II=)


### 4、DDD架构 vs 整洁架构 vs 六边形架构

**1. 整洁架构**

在整洁架构里，同心圆代表应用软件的不同部分，从里到外依次是领域模型、领域服务、应用服务和最外围的容易变化的内容，比如用户界面和基础设施。 整洁架构最主要的原则是依赖原则，它定义了各层的依赖关系，越往里依赖越低，代码级别越高，越是核心能力。外圆代码依赖只能指向内圆，内圆不需要知道外圆的任何情况。

![img](http://cdn.processon.com/5f89426563768906e674c620?e=1602834549&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:nyxuYVk8j937LiOVDrHDZVfQZXE=)

在整洁架构里，同心圆代表应用软件的不同部分，从里到外依次是领域模型、领域服务、应用服务和最外围的容易变化的内容，比如用户界面和基础设施。 整洁架构最主要的原则是依赖原则，它定义了各层的依赖关系，越往里依赖越低，代码级别越高，越是核心能力。外圆代码依赖只能指向内圆，内圆不需要知道外圆的任何情况。 
在洋葱架构中，各层的职能是这样划分的： - 领域模型实现领域内核心业务逻辑，它封装了企业级的业务规则。领域模型的主体是实体，一个实体可以是一个带方法的对象，也可以是一个数据结构和方法集合。 领域服务实现涉及多个实体的复杂业务逻辑。 - 应用服务实现与用户操作相关的服务组合与编排，它包含了应用特有的业务流程规则，封装和实现了系统所有用例。 - 最外层主要提供适配的能力，适配能力分为主动适配和被动适配。主动适配主要实现外部用户、网页、批处理和自动化测试等对内层业务逻辑访问适配。被动适配主要是实现核心业务逻辑对基础资源访问的适配，比如数据库、缓存、文件系统和消息中间件等。 - 红圈内的领域模型、领域服务和应用服务一起组成软件核心业务能力。

**2. 六边形架构**

六边形架构又名“端口适配器架构”。追溯微服务架构的渊源，一般都会涉及到六边形架构。

六边形架构的核心理念是：**应用是通过端口与外部进行交互的。**

![img](http://cdn.processon.com/5f8943fd1e085307a08fe6f1?e=1602834957&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:TAcEM1DJ5jKSD4IffNhuU8EvCRs=)

六边形架构中，红圈内的核心业务逻辑（应用程序和领域模型）与外部资源（包括 APP、Web 应用以及数据库资源等）完全隔离，仅通过适配器进行交互。它解决了业务逻辑与用户界面的代码交错问题，很好地实现了前后端分离。六边形架构各层的依赖关系与整洁架构一样，都是由外向内依赖。 六边形架构将系统分为内六边形和外六边形两层，这两层的职能划分如下： - 红圈内的六边形实现应用的核心业务逻辑； - 外六边形完成外部应用、驱动和基础资源等的交互和访问，对前端应用以 API 主动适配的方式提供服务，对基础资源以依赖倒置被动适配的方式实现资源访问。 - 六边形架构的一个端口可能对应多个外部系统，不同的外部系统也可能会使用不同的适配器，由适配器负责协议转换。这就使得应用程序能够以一致的方式被用户、程序、自动化测试和批处理脚本使用。


**3. 三者比较**

![img](http://cdn.processon.com/5f89445a5653bb06ef02a16f?e=1602835050&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:kCfz4BMnazC6W_Y68WyKUVw1F_E=)

请你重点关注图中的红色线框，它们是非常重要的分界线，这三种架构里面都有，它的作用就是将核心业务逻辑与外部应用、基础资源进行隔离。 - 红色框内部主要实现核心业务逻辑，但核心业务逻辑也是有差异的，有的业务逻辑属于领域模型的能力，有的则属于面向用户的用例和流程编排能力。按照这种功能的差异，我们在这三种架构中划分了应用层和领域层，来承担不同的业务逻辑。 - 领域层实现面向领域模型，实现领域模型的核心业务逻辑，属于原子模型，它需要保持领域模型和业务逻辑的稳定，对外提供稳定的细粒度的领域服务，所以它处于架构的核心位置。 - 应用层实现面向用户操作相关的用例和流程，对外提供粗粒度的 API 服务。它就像一个齿轮一样进行前台应用和领域层的适配，接收前台需求，随时做出响应和调整，尽量避免将前台需求传导到领域层。应用层作为配速齿轮则位于前台应用和领域层之间。 - 可以说，这三种架构都考虑了前端需求的变与领域模型的不变。需求变幻无穷，但变化总是有矩可循的，用户体验、操作习惯、市场环境以及管理流程的变化，往往会导致界面逻辑和流程的多变。但总体来说，不管前端如何变化，在企业没有大的变革的情况下，核心领域逻辑基本不会大变，所以领域模型相对稳定，而用例和流程则会随着外部应用需求而随时调整。把握好这个规律，我们就知道该如何设计应用层和领域层了。 架构模型通过分层的方式来控制需求变化从外到里对系统的影响，从外向里受需求影响逐步减小。面向用户的前端可以快速响应外部需求进行调整和发布，灵活多变，应用层通过服务组合和编排来实现业务流程的快速适配上线，减少传导到领域层的需求，使领域层保持长期稳定。 这样设计的好处很明显了，就是可以保证领域层的核心业务逻辑不会因为外部需求和流程的变动而调整，对于建立前台灵活、中台稳固的架构很有帮助。

### 5、防腐层

在老系统中想升级成DDD，可以引入防腐层

不要把与领域无关的逻辑放在领域层实现，保证领域层的纯洁和领域逻辑的稳定，避免污染
领域模型。也不要把领域模型的业务逻辑放在应用层，这样会导致应用层过于庞大，最终领
域模型会失焦。如果实在无法避免，我们可以引入防腐层，进行新老系统的适配和转换，过
渡期完成后，可以直接将防腐层代码抛弃。


6、DDD分层架构如何落地在微服务中

**1、 项目级微服务**

![img](http://cdn.processon.com/5f8948c4f346fb06e1d817ec?e=1602836180&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:ulnEfEBYsYoIrnmiQwq8myoqBmk=)

**2. 企业级中台微服务**

![img](http://cdn.processon.com/5f8948d45653bb06ef02b4ad?e=1602836197&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:hQDFbeqvGDwd35TQWtWTKqEPNww=)

## 中台

### 1、中台是什么

先看一下阿里自己人对中台的定义：“中台是一个基础的理念和架构，我们要把所有的基础服务用中台的思路建设，进行联通，共同支持上端的业务。业务中台更多的是支持在线业务，数据中台提供了基础数据处理能力和很多的数据产品给所有业务方去用。业务中台、数据中台、算法中台等等一起提供对上层业务的支撑。” 再看一下思特沃克对中台的定义：“中台是企业级能力复用平台。” 综上，我们可以提炼出几个关于中台的关键词：共享、联通、融合和创新。 - 联通是前台以及中台之间的联通， - 融合是前台流程和数据的融合， - 并以共享的方式支持前端一线业务的发展和创新。 我认为，中台首先体现的是一种企业级的能力，它提供的是一套企业级的整体解决方案，解决小到企业、集团，大到生态圈的能力共享、联通和融合问题，支持业务和商业模式创新。 通过平台联通和数据融合为用户提供一致的体验，更敏捷地支撑前台一线业务。 **中台来源于平台，但中台和平台相比，它更多体现的是一种理念的转变，它主要体现在这三个关键能力上：对前台业务的快速响应能力；企业级复用能力；从前台、中台到后台的设计、研发、页面操作、流程服务和数据的无缝联通、融合能力。** 其中最关键的是快速响应能力和企业级的无缝联通和融合能力，尤其是对于跨业经营的超大型企业来说至关重要。

**中台是企业级能力复用平台**

背景故事

2015 关键词：阿里巴巴中台战略诞生 历史就像一列行驶在山脊间的列车，一切都在按照既定的方向不紧不慢地向前推进。 中台这个新物种也正在时间的推进中不断孕育，只在等待一个契机的到来。 2015 年，终于等来了这个契机。 接下来就是大家津津乐道的那个故事：在 2015 年，马云带领阿里众高管一起拜访了位于芬兰、号称是世界上最成功的移动游戏公司 Supercell。说起这家公司，你可能会觉得比较陌生，但是提到这个公司开发的游戏，相信你一定有所耳闻，《部落战争》《海岛奇兵》《卡通农场》等等知名的游戏都出于这家游戏公司之手。 但当时触动马云和阿里高管团队的是，催生了这么多火遍全球游戏的企业，却只有不到 200 名员工。而负责一款游戏的每个团队平均也只有 5 到 7 名团队成员。团队有充分的自由，他们可以自行决定开发什么样的产品，之后就会以最快的速度推出公测版，让市场来评判，来验证产品的好坏。一旦产品不成功，则迅速放弃，此时不但不会有任何惩罚，反而团队会举杯庆祝，之后立即做出调整继续迅速寻找新的方向。 嗯，是的，这就是典型的精益创业的套路。 但要想让这个机制得以正常运转，必须有一个前提，就是产品的构建时间要足够短，试错的成本要足够低，这样才能保证团队在大量的试错中，通过不断从失败中学习，持续迭代调整，尽快找到正确的方向，让创新成功的进度条快速前进。 而背后支撑这个机制得以实现的，就是 Supercell 经过 6 年时间沉淀下来的游戏开发过程中那些公共的、通用的游戏素材和算法。基于这些像乐高积木一样的基础素材和算法，才可以同时支持几个小团队在几周时间内像搭积木一样快速研发出一款新游戏。 这种方式触动了到访的阿里巴巴高管团队，这种理念与阿里巴巴及业界这么多年一直在尝试和构思的“厚平台，薄应用”架构方向不谋而合。就是这次拜访，坚定了阿里巴巴管理层对于组织架构调整的决心，也加速催化了阿里巴巴中台战略的正式诞生。 随后不久，在 2015 年 12 月 7 日，时任阿里巴巴集团 CEO 的张勇通过一封内部信说道：“今天起，我们全面启动阿里巴巴集团 2018 年中台战略，构建符合 DT 时代的更创新灵活的‘大中台、小前台’组织机制和业务机制。” 至此，阿里巴巴中台战略正式诞生，而之前的“厚平台，薄应用”也顺势变成了“大中台，小前台”。 但有意思的是，在 2015 年阿里巴巴中台战略刚刚被提出的时候，印象中并没有掀起多大的波澜。当时大家谈论的还是花千骨和《我的滑板鞋》，而互联网圈聊的更多的也是互联网 + 和 O2O。熟不知，一场新的战场已经开始孕育，种子已经种下。


### 2、中台 vs 平台

中台来源于平台，但中台和平台相比，它更多体现的是一种理念的转变，它主要体现在这三个关键能力上：
对前台业务的快速响应能力；
企业级复用能力；
从前台、中台到后台的设计、研发、页面操作、流程服务和数据的无缝联通、融合能力。

**中台的本质其实就是提炼各个业务板块的共同需求，进行业务和系统抽象，形成通用的可复**
**用的业务模型，打造成组件化产品，供前台部门使用。前台要做什么业务，需要什么资源，
可以直接找中台，不需要每次都去改动自己的底层。**

传统企业可以将需要共享的公共能力进行领域建模，建设可共享的**通用中台**。

传统企业还会将核心能力进行领域建模，建设面向不同渠道的可复用的**核心中台**。

![img](http://cdn.processon.com/5f8ced04e401fd06fd91bc46?e=1603074837&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:6FCxUY4REmhleFvC2XiUgPk07vk=)


### 3、业务中台

业务中台更多的是支持在线业务

业务中台的建设可采用领域驱动设计方法，通过领域建模，将可复用的公共能力从各个单体剥离，沉淀并组合，采用微服务架构模式，建设成为可共享的通用能力中台。

在将传统集中式单体按业务职责和能力细分为微服务，建设中台的过程中，会产生越来越多的独立部署的微服务。这样做虽然提升了应用弹性和高可用能力，但由于微服务的物理隔离，原来一些系统内的调用会变成跨微服务调用，再加上前后端分离，微服务拆分会导致数据进一步分离，增加企业级应用集成的难度。 如果没有合适的设计和指导思想，处理不好前台、中台和后台的关系，将会进一步加剧前台流程和数据的孤岛化、碎片化。

### 4、数据中台

数据中台提供了基础数据处理能力和很多的数据产品给所有业务方去用

数据中台主要完成数据的融合和加工，萃取数据业务价值，支持业务创新，对外提供数据共享服务。

数据中台的主要目标是打通数据孤岛，实现业务融合和创新，包括三大主要职能：

一是完成企业全域数据的采集与存储，实现各不同业务类别中台数据的汇总和集中管
理。

二是按照标准的数据规范或数据模型，将数据按照不同主题域或场景进行加工和处理，
形成面向不同主题和场景的数据应用，比如客户视图、代理人视图、渠道视图、机构视
图等不同数据体系。

三是建立业务需求驱动的数据体系，基于各个维度的数据，深度萃取数据价值，支持业
务和商业模式的创新。

数据中台的建设就可分为三步走：

第一步实现各中台业务数据的汇集，解决数据孤岛和初级数据共享问题。

第二步实现企业级实时或非实时全维度数据的深度融合、加工和共享。

第三步萃取数据价值，支持业务创新，加速从数据转换为业务价值的过程。

### 5、其它类型的中台

技术中台

研发中台

移动中台

管理中台

组织中台

### 6、中台建设前必须想清楚的四个问题

其实中台建设是一个非常“凶险”的过程，上面的问题只是最基础的问题。 想清楚这些问题之所以重要，是因为他们能帮我们判断中台建设的“周边环境”是否已经准备就绪。我们看到很多企业建设中台，有的成功有的失败，其实不是因为实力和方法上有什么太大的差别，大家碰到的问题和困难往往都是一样的。 最主要还是中台孵化的环境是否已经成熟。有的企业最终没有成功反而是因为走得太早了，思路太超前了，周边环境还没有就绪。

1、中台建设的愿景是什么？

愿景帮助我们了解自己中台建设的目标，帮助我们判断哪些事情是符合中台建设愿景的，作为中台团队我们需要去考虑。在这之外，更重要的是帮我们判断哪些事情不是中台要去做的，为中台做减法，这点在中台的建设过程中其实更加重要。

2、中台的用户和客户是谁？

中台建设虽然需要兼顾各方的利益，但更多主要还是解决企业管理层对于公司长期生存与可持续发展的恐惧与焦虑问题。

3、中台的钱由谁出？

众筹模式：众筹模式就是用户预付款，生产方承诺一定时间后提供某一类型的产品。

投融资模式：一个产品的建设前期先由投资方出资，按照产品的建设目标经过一段时间的建设期，相对成熟之后，再逐渐地让用户使用，最终通过对于用户的服务，让用户满意，实现收入并收回企业投资且盈利的模式。

4. 中台的目标怎么验证？

通过提前考虑这个问题，让我们可以在建设的中后期规避一些扯皮和风险。

目前业界有一些中台的考核标准我们可以作为参考，例如阿里巴巴的中台考核就是设计成：40% 稳定性 +25% 业务创新 +20% 服务接入量 +15% 客户满意度。

### 7、中台建模

![img](http://cdn.processon.com/5f895a717d9c0806f27af2a7?e=1602840706&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:Zn56WvMDCHw9EEKxOe4fh1W4qNY=)

- 第一步：按照业务流程（通常适用于核心域）或者功能属性、集合（通常适用于通用域或支撑域），将业务域细分为多个中台，再根据功能属性或重要性归类到核心中台或通用中台。核心中台设计时要考虑核心竞争力，通用中台要站在企业高度考虑共享和复用能力。 - 第二步：选取中台，根据用例、业务场景或用户旅程完成事件风暴，找出实体、聚合和限界上下文。依次进行领域分解，建立领域模型。 - 第三步：以主领域模型为基础，扫描其它中台领域模型，检查并确定是否存在重复或者需要重组的领域对象、功能，提炼并重构主领域模型，完成最终的领域模型设计。 - 第四步：选择其它主领域模型重复第三步，直到所有主领域模型完成比对和重构。 - 第五步：基于领域模型完成微服务设计，完成系统落地。

![img](http://cdn.processon.com/5f895b6be0b34d07110a5091?e=1602840955&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:9P0hZPK1CoFNy0H9dSBSZeavDZ4=)

DDD 中台设计的过程。DDD 战略设计包括上述的第
一步到第四步，主要为：业务域分解为中台，对中台归类，完成领域建模，建立中台业务模
型。DDD 战术设计是第五步，领域模型映射为微服务，完成中台建设。

![img](http://cdn.processon.com/5f8ab3ec7d9c0806f27c73ac?e=1602929148&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:WbwuEteyXV1rTmx5KRcdZCz7940=)

### 8、DDD vs 微服务 vs 中台

中台本质是平台，需要站在很高的高度来看，分为业务中台和数据中台两种。业务中台是一种业务模型，这个模型是站的角度往往是平台去设计的，是抽象出来的业务模型，数据中台是一个数据平台。
微服务是业务模型的系统落地，
DDD 是一种业务模型设计思想，
它可以同时指导中台业务建模和微服务设计，它们之间就是这样的一个铁三角关系。

**“适合自己的才是最好的。”，一切以解决实际问题为出发点。

**微服务拆分**

理论上DDD的限界上下文就是微服务的边界。我们将限界上下文内的领域模型映射到微服务，就完成了从问题域到软件的解决方案。

``` 限界上下文是微服务设计和拆分的主要依据。在领域模型中，如果不考虑技术异构、团队沟通等其它外部因素，一个限界上下文理论上就可以设计为一个微服务。 不过，这里还是要提示一下：除了理论，微服务的拆分还是有很多限制因素的，在设计中不宜过度拆分。 ```

**DDD vs 中台**

![img](http://cdn.processon.com/5f8958bd1e085307a0904358?e=1602840269&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:26j0jkNufLKCb_L952JI-_D6NmE=)

根据 DDD 首先要建立通用语言的原则，在将 DDD 的方法引入中台
设计时，我们要先建立中台和 DDD 的通用语言。这里的子域与中台是一致的，那我们就可
以将子域统一为中台。

**避免重复造轮子**

你需要站在企业高度，将重复的需要共享的通用能力、核心能力沉淀到中台，将分离的业务
能力重组为完整的业务板块，构建可复用的中台业务模型。前端个性能力归前端，后端管理
能力归后台。建立前、中、后台边界清晰，融合协作的企业级可复用的业务模型。

**构建中台业务模型**

自顶向下的策略

这种策略是先做顶层设计，从最高领域逐级分解为中台，分别建立领域模型，根据业务属性分为通用中台或核心中台。领域建模过程主要基于业务现状，暂时不考虑系统现状。自顶向下的策略适用于全新的应用系统建设，或旧系统推倒重建的情况。

自底向上的策略

这种策略是基于业务和系统现状完成领域建模。首先分别完成系统所在业务域的领域建模；然后对齐业务域，找出具有同类或相似业务功能的领域模型，对比分析领域模型的差异，重组领域对象，重构领域模型。这个过程会沉淀公共和复用的业务能力，会将分散的业务模型整合。自底向上策略适用于遗留系统业务模型的演进式重构。分为三个步骤

第一步：锁定系统所在业务域，构建领域模型。

锁定系统所在的业务域，采用事件风暴，找出领域对象，构建聚合，划分限界上下文，建立领域模型。

![img](http://cdn.processon.com/5f8968ce7d9c0806f27b2909?e=1602844383&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:5UuhWU2i2GFYBfKG7vTmmOZruf4=)

第二步：对齐业务域，构建中台业务模型。

![img](http://cdn.processon.com/5f8968e57d9c0806f27b2971?e=1602844408&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:VnM_LAvjrQrTVgGD1Z7WWgkX9n4=)

![img](http://cdn.processon.com/5f8968ffe401fd06fd8eaa1d?e=1602844432&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:mYkTVGKsCZbMky7R6QrGhSPesik=)

第三步：中台归类，根据领域模型设计微服务。

![img](http://cdn.processon.com/5f89692c63768906e675658d?e=1602844478&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:0T0cvDXb6GU_Luk62QAM6dOcWDk=)

重构过程中的领域对象

部分领域对象可能会根据新的业务要求，从原来的聚合中分离，重组到其它
聚合。新领域模型的领域对象，比如实体、领域服务等，在重组后可能还会根据新的业务场
景和需求进行代码重构。

![img](http://cdn.processon.com/5f89698563768906e675667d?e=1602844565&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:8FByEzZLkxTkRu6NNNMEawBUz7E=)

![img](http://cdn.processon.com/5f8cee6ee0b34d07110d96cd?e=1603075198&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:_Ij2Lzx7mkg4cUUKEiDhbWIP0SU=)

### 9、总结

![img](http://cdn.processon.com/5f87e14c63768906e671c43c?e=1602744156&token=trhI0BY8QfVrIGn9nENop6JAc6l5nZuxhjQ62UfM:RT62Zh_3YaT4gjfPSaIOoCb1Om8=)

怎么划分子域，限界上下文等？

对一个问题不断地划分，直到划分为我们熟悉的、能够快速处理的小问题。然后再对小问题的处理排列一个优先级。
领域细分到一定的范围后，我们就可以对这个子域进行事件风暴，为这个子域划分限界上下文，建立领域模型，然后就可以基于领域模型进行微服务设计了。

DDD 没有明确说明子域和限界上下文的关系。

每个企业由于商业模式或者战略方向不一样，核心域会有一些差异，不要用固定的眼光看待不同企业的核心域。

仓储模式

关于聚合设计过程中的一些原则问题。大部分的业务场景我们都可以通过事件风暴，找到聚
合根，建立聚合，划分限界上下文，建立领域模型。但也有部分场景，比如数据计算、统计
以及批处理业务场景，所有的实体都是独立无关联的，**找不到聚合根，也无法建立领域模
型。但是它们之间的业务关系是非常紧密的，在业务上是高内聚的。我们也可以将这类场景
作为一个聚合处理，除了不考虑聚合根的设计方法外，其它诸如 DDD 分层架构相关的设计
方法都是可以采用的。**

一切为了解决问题，不能为了DDD，而DDD
